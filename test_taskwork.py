# -*- coding: utf-8 -*-
# 1.本文件及调用的Python文件为范例代码
# 2.另期货PYTHON程序化交易框架遵循 开源协议GPL v3
# 简单的说：对基于GPL v3协议的源代码，若个人或机构仅仅是自己使用，则可以闭源。
# 若基于该开源代码，开发出程序或衍生产品用于商业行为则也必须开源。

# Quciklib Python框架和工具遵循GPL v3协议包括：
# （1）Quicklib CTP   期货行情库
# （2）Quicklib CTP   期货交易库
# （3）Quicklib CTP2  A股行情库
# （4）Quicklib MOM模式  博易资管交易库
# （用于接入资管投顾系统，MOM模式可实现私募进行投顾的选拔考核，并通过自己的风控系统接入实盘）

# Quciklib Python框架和工具暂不遵循开源协议包括：
# （5）Quicklib 监控器库（预警、监控、交易信号数据复制、跟单）（可免费试用）

# 对Quciklib开源库做出贡献的，并得到原始作者肯定的，将公布在http://www.quciklib.cn网站上，
# 并添加在《开源说明和感谢.txt》，并将该文件不断更新放入每一个新版本的Quicklib库里。

# 原始作者：QQ 147423661 林
# 官方网站：http://www.quicklib.cn
# 官方QQ群：5172183(1群)、25884087(2群)

import time, sys, Queue
from multiprocessing.managers import BaseManager


# 创建类似的QueueManager:
class QueueManager(BaseManager):
    pass


# 由于这个QueueManager只从网络上获取Queue，所以注册时只提供名字:
QueueManager.register('get_task_queue')
QueueManager.register('get_result_queue')

# 连接到服务器，也就是运行taskmanager.py的机器:
server_addr = '127.0.0.1'
print('Connect to server %s...' % server_addr)
# 端口和验证码注意保持与taskmanager.py设置的完全一致:
m = QueueManager(address=(server_addr, 5000), authkey='abc')
# 从网络连接:
m.connect()
# 获取Queue的对象:
task = m.get_task_queue()
result = m.get_result_queue()
# 从task队列取任务,并把结果写入result队列:
for i in range(10):
    try:
        n = task.get(timeout=1)
        print('run task %d * %d...' % (n, n))
        r = '%d * %d = %d' % (n, n, n * n)
        time.sleep(1)
        result.put(r)
    except Queue.Empty:
        print('task queue is empty.')
# 处理结束:
print('worker exit.')